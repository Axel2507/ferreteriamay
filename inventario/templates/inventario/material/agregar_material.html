{% extends  'base.html' %}
{% block content %}
{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agregar Material</title>
    <link rel="stylesheet" href="{% static 'css/estilos.css' %}?v={% now 'U' %}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>Agregar Nuevo Material</h2>
        </div>
        {% if error %}
            <div class="alert alert-danger">
                {{ error }}
            </div>
        {% endif %}
        <form id="formMaterial" method="post">
            {% csrf_token %}
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">Código de Barras:</label>
                        <input type="text" class="form-control" id="codigo" name="codigo" placeholder="Escanea o ingresa manualmente" required>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">Nombre Material:</label>
                        <input type="text" class="form-control" id="nombre" name="nombre" required>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">Cantidad en Stock:</label>
                        <input type="number" class="form-control" id="stock" name="stock" min="0" required>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">Stock Mínimo:</label>
                        <input type="number" class="form-control" id="stock_minimo" name="stock_minimo" min="0" required>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">Precio de Compra:</label>
                        <input type="number" class="form-control" id="precio_compra" name="precio_compra" min="0" step="0.01" required>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">Precio de Venta:</label>
                        <input type="number" class="form-control" id="precio_venta" name="precio_venta" min="0" step="0.01" required>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="form-label">Categoría:</label>
                        <select class="form-select" id="categoria" name="categoria" required>
                            <option value="">Seleccionar categoría</option>
                            {% for categoria in categorias %}
                                <option value="{{ categoria.id }}">{{ categoria.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="form-group">
                        <label class="form-label">Proveedor:</label>
                        <select class="form-select" id="proveedor" name="proveedor" required>
                            <option value="">Seleccionar proveedor</option>
                            {% for proveedor in proveedores %}
                                <option value="{{ proveedor.id_proveedor }}">{{ proveedor.nombre_empresa }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="form-group">
                        <label class="form-label">Unidad de Medida por Compra:</label>
                        <select class="form-select" id="unidad_compra" name="unidad_compra" required>
                            <option value="">Seleccionar unidad</option>
                            {% for unidad in unidades %}
                                <option value="{{ unidad.id }}">{{ unidad.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="form-label">Unidad de Medida por Venta:</label>
                        <select class="form-select" id="unidad_venta" name="unidad_venta" required>
                            <option value="">Seleccionar unidad</option>
                            {% for unidad in unidades %}
                                <option value="{{ unidad.id }}">{{ unidad.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">Factor de Conversión:</label>
                        <input type="number" class="form-control" id="factorc" name="factor_conversion" min="1" step="0.01" required>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">Fecha de Caducidad (opcional):</label>
                        <input type="date" class="form-control" id="fecha_caducidad" name="fecha_caducidad">
                    </div>
                </div>
                <div class="col-md-6" style="margin-top: 30px;">
                    <div class="form-group">
                        <button type="submit" class="btn" id="agregarMaterial">Agregar Material</button>
                    </div>
                </div>
            </div>

        </form>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', (event) => {
        // Conéctate al servidor Socket.IO (tu barcode_bridge.py)
        // Asegúrate que la URL y el puerto coinciden con tu barcode_bridge.py
        const socket = io.connect('http://ferremay.com:5001');

        const codigoInput = document.getElementById('codigo'); // ID del input

        socket.on('connect', () => {
            console.log('AGREGAR_MAT: Conectado al servidor WebSocket del puente.');
            // Podrías solicitar el último código aquí si el servidor no lo envía automáticamente al conectar
            // socket.emit('request_last_barcode'); 
        });

        socket.on('disconnect', () => {
            console.log('AGREGAR_MAT: Desconectado del servidor WebSocket del puente.');
        });

        socket.on('connect_error', (error) => {
            console.error('AGREGAR_MAT: Error de conexión WebSocket:', error);
        });

        // Escuchar el evento 'nuevo_codigo_barra' enviado por el servidor
        socket.on('nuevo_codigo_barra', (data) => {
            const barcode = data.barcode;
            console.log('AGREGAR_MAT: Nuevo código de barras recibido vía WebSocket:', barcode);

            if (barcode && typeof barcode === 'string' && barcode.trim() !== "") {
                if (codigoInput) {
                    if (codigoInput.value !== barcode) {
                        console.log("AGREGAR_MAT: Actualizando input 'codigo' con:", barcode);
                        codigoInput.value = barcode;
                        // Opcional: Mover el foco o realizar otra acción
                        // codigoInput.focus();
                    } else {
                        // console.log("AGREGAR_MAT: El código de barras ya está en el input 'codigo'.");
                    }
                } else {
                    console.error("AGREGAR_MAT: ¡ERROR! No se encontró el input con id='codigo'.");
                }
            }
        });

        // Escuchar el evento 'last_known_barcode' (si el servidor lo envía al conectar)
        socket.on('last_known_barcode', (data) => {
            const barcode = data.barcode;
            console.log('AGREGAR_MAT: Último código conocido recibido al conectar:', barcode);
            if (barcode && typeof barcode === 'string' && barcode.trim() !== "") {
                if (codigoInput && codigoInput.value === "") { // Solo rellenar si está vacío
                    console.log("AGREGAR_MAT: Rellenando input 'codigo' con último código conocido:", barcode);
                    codigoInput.value = barcode;
                }
            }
        });
    });
</script>
</body>
</html>
{% endblock %}
